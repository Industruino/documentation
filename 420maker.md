# Industruino 4-20mAker product documentation

*Current version: HW REV: 4.0, FW REV: 1.0*

1. Setting up the Arduino [IDE](#setting-up-the-arduino-ide)
2. [Wiring](#wiring-example) example
3. [SAML](#saml-board-specific-features) specific features
4. [GPIO](#gpio) notes
5. [WDT](#wdt)
6. [Application notes](#application-notes)
7. [Tested sensors](#tested-sensors)
8. [Security bit](#security-bit) protect your code

For datasheets, user manuals, pinout maps, see [industruino.com](https://industruino.com/page/techcentre)

![420maker](https://industruino.com/website/image/product.template/89_9ad0531/image)


# Setting up the Arduino IDE

The 4-20mAker is compatible with the Arduino IDE (minimum version 1.8.2) with automatic install via board manager: 
* In *File > Preferences > Additional Boards Manager URLs:* add https://static.industruino.com/downloads/code/IndustruinoCores/IndustruinoSAML/pkgdef/package_industruino_saml_index.json 
* Enter the Board Manager via *Tools > Board* and search for 'industruino'
* Install the Industruino SAML package
* *Industruino 4-20mAker* will show up in the Boards list in *Tools > Board* in section *Industruino SAML*
* Windows driver (if necessary) at https://static.industruino.com/downloads/drivers/drivers-industruino-windows-1.0.0.zip

Important notes:
1. The 4-20mAker needs to be connected to a power source in order to switch on and be detected by the computer; the USB connection does not power it up.
2. While the USB is connected, the 4-20mAker output is stuck at around 1mA; as soon as the USB is disconnected, it will output the coded value. 


# Wiring example

When using the 4-20mAker with the IND.I/O analog input channels, this is the default wiring for the current loop, using the same power supply for both devices:
* IND.I/O V+ (24V) <-> 4-20mAker V+
* 4-20mAker V- <-> IND.I/O analog input channel
* IND.I/O V- (GND) <-> IND.I/O analog GND

If using a separate power supply for each device:
* analog PSU V+ <-> 4-20mAker V+
* 4-20mAker V- <-> IND.I/O analog input channel
* IND.I/O analog GND <-> analog PSU V-


# SAML board specific features

* The 4-20mAker has an Atmel ATSAML21E18B MCU.
* `RESET` button is located behind the green screw terminal; double tap resets the MCU.
* Serial ports on SAML:
  * SerialUSB for USB (Serial Monitor)
  * Serial for hardware serial on D6/D5 (if configured in the IDE menu *Tools > Board*)
* Built in LED is on D0 (no PWM)
* The 4-20mA current is generated by DAC:
  * the DAC uses an external voltage reference:   
  ```DAC->CTRLB.bit.REFSEL = 0x00; //Set DAC to external VREF (2.5V)```
  * the DAC has 12-bit resolution:   
  ```analogWriteResolution(12);```
  * write a 12-bit number X to the current loop: (0-4095 corresponds to 3.8-20.7mA)   
  ```analogWrite(PIN_DAC0, X);```
* The SERCOM functions of the 6 GPIO pins can be chosen as options in the IDE menu *Tools > Board*
  * SPI + I2C
  * SPI + UART
  * I2C + UART
* Depending on what sensor you use, you may need pull-up resistors on the I2C lines
* The 3V3 pin can be switched on and off in the code:  
```digitalWrite(PIN_EXT_3V3_ENABLE, HIGH);```  
  The initial state of this pin can be set as an option in the IDE menu *Tools > Board*


# GPIO

The green screw connector gives access to 6 GPIO pins. These pins are all capable of digital input/output, analog input, and pwm output. 3V3 signal level, max 3.6V

Additional functions depend to the option chosen in the IDE menu *Tools > Board*:

| header pin number	| MCU pin	| additional function |
| --- | --- | --- | 
| 1	| D1	| SPI_MISO  |
| 2	|	D2 | SPI_SS |
| 3	| D3	| SPI_MOSI |
| 4	| D4	| SPI_SCK |
| 5	| D5	| UART_TX or I2C_SDA |
| 6	| D6	| UART_RX or I2C_SCL|
| 7 | GND | GND | 
| 8 | 3V3 | 3V3 on or off | 


# WDT

We can use the WDT functions available in the SAML core. The WDT period can be set from 8ms to 16sec. Additional features are documented in the SAML datasheet.

To initialise, configure, and enable the WDT:
```
  WDT->CTRLA.reg = 0;                       // init
  WDT->CONFIG.reg = WDT_CONFIG_PER_CYC2048; // set timeout period based on 1.024kHz clock, from 8ms to 16sec, CYC = 1ms
  // options: WDT_CONFIG_PER_CYC8 WDT_CONFIG_PER_CYC16 WDT_CONFIG_PER_CYC32 WDT_CONFIG_PER_CYC64 WDT_CONFIG_PER_CYC128
  // WDT_CONFIG_PER_CYC256 WDT_CONFIG_PER_CYC512 WDT_CONFIG_PER_CYC1024 WDT_CONFIG_PER_CYC2048 WDT_CONFIG_PER_CYC4096
  // WDT_CONFIG_PER_CYC8192 WDT_CONFIG_PER_CYC16384

  WDT->CTRLA.reg = WDT_CTRLA_ENABLE;        // enable
```
To clear the WDT:
```
  WDT->CLEAR.reg = WDT_CLEAR_CLEAR_KEY;   // reset the WDT: without this line, the WDT would cause a reset after the period defined above
```


# Application notes


### Available power

* To achieve the minimum 4mA on the loop,  the 3.3V sensor should not consume more than 15mA averaged (The transmitter has significant capacitance on the sensor supply rail, so short higher current peaks can absorbed, depending on the duration and interval). 
* Higher average current is supported and will not damage the transmitter, it will only raise the minumum controllable loop current above 4mA, thus reducing your range and resolution (e.g. range of 10-20mA).
* The same situation occurs when the transmitter is powered by less than 24V: the output range may be reduced, depending on the power consumption of your additional sensors.

### USB isolator

Due to the non-isolated nature of the transmitter we recommend that you use a USB isolator for programming and calibration via the USB port.


# Tested sensors

Sensor | Type | Tested | Example sketch |Remarks
--- | --- | --- | --- | ---
DHT11 | temperature + humidity | OK | [dht11-demo](https://github.com/Industruino/democode/blob/master/420mAker/dht11-demo/dht11-demo.ino) | use pull-up resistor as usual for the DHT11 but not for the DHT22
DS18B20 | temperature | OK | [ds18b20-demo](https://github.com/Industruino/democode/blob/master/420mAker/ds18b20-demo/ds18b20-demo.ino) | use pull-up resistor as usual
MPU6050 | gyro + accelerometer | OK | [mpu6050-demo](https://github.com/Industruino/democode/blob/master/420mAker/mpu6050-demo/mpu6050-demo.ino) |
RC522 | rfid | OK | [rfid-mfrc522-demo](https://github.com/Industruino/democode/blob/master/420mAker/rfid-mfrc522-demo/rfid-mfrc522-demo.ino) | requires around 10mA at 3.3V so reduce the output range to e.g. 10-20mA

# Security bit

In order to protect the intellectual property of your code, it is possible to set a security bit in the SAMD21G microcontroller, which effectively blocks any attempt to download the compiled code from the microcontroller's internal FLASH memory by a third party. 

* A demo sketch which sets this bit can be found [here](https://github.com/Industruino/democode/tree/master/SAML21B_SecurityBit). You can integrate the functions seen in this demo  sketch into your own application sketch. 

* Running the ```if (!setSecurityBit()){};``` command in your Setup() routine will enable the security bit. 

WARNING: Afterwards you will still be able to upload new code (the old protected code gets erased), but you can not read-back the FLASH contents of the MCU. To disable the security you will need to use an in-circuit debugger such as the Atmel ICE.
