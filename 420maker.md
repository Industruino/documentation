# Industruino 4-20mAker product documentation

*Current version: HW REV: 4.0, FW REV: 1.0*

1. Setting up the Arduino [IDE](#setting-up-the-arduino-ide)
2. [Wiring](#wiring-example) example
3. [SAML](#saml-board-specific-features) specific features
4. [GPIO](#gpio) pinout
5. [WDT](#wdt)
6. [Application notes](#application-notes)

For datasheets, user manuals, pinout maps, see [industruino.com](https://industruino.com/page/techcentre)

![420maker](https://industruino.com/website/image/product.template/89_9ad0531/image)


# Setting up the Arduino IDE

The 4-20mAker is compatible with the Arduino IDE with automatic install via board manager: 
* In *File > Preferences > Additional Boards Manager URLs:* add https://static.industruino.com/downloads/code/IndustruinoCores/IndustruinoSAML/pkgdef/package_industruino_saml_index.json 
* Enter the Board Manager via *Tools > Board* and search for 'industruino'
* Install the Industruino SAML package
* *Industruino 4-20mAker* will show up in the Boards list in *Tools > Board* in section *Industruino SAML*

Important notes:
1. The 4-20mAker needs to be connected to a power source in order to switch on and be detected by the computer; the USB connection does not power it up.
2. While the USB is connected, the 4-20mAker output is stuck at around 1mA; as soon as the USB is disconnected, it will output the coded value. 


# Wiring example

When using the 4-20mAker with the IND.I/O analog input channels, this is the default wiring for the current loop, using the same power supply for both devices:
* IND.I/O V+ (24V) <-> 4-20mAker V+
* 4-20mAker V- <-> IND.I/O analog input channel
* IND.I/O V- (GND) <-> IND.I/O analog GND

If using a separate power supply for each device:
* analog PSU V+ <-> 4-20mAker V+
* 4-20mAker V- <-> IND.I/O analog input channel
* IND.I/O analog GND <-> analog PSU V-


# SAML board specific features

* The 4-20mAker has an Atmel SAML21E MCU.
* `RESET` button is located behind the green screw terminal; double tap resets the MCU.
* Serial ports on SAML:
  * SerialUSB for USB (Serial Monitor)
  * Serial for hardware serial on D6/D5 (if configured in the IDE menu *Tools > Board*)
* Built in LED is on D0 (no PWM)
* The 4-20mA current is generated by DAC:
  * the DAC uses an external voltage reference:   
  ```DAC->CTRLB.bit.REFSEL = 0x00; //Set DAC to external VREF (2.5V)```
  * the DAC has 12-bit resolution:   
  ```analogWriteResolution(12);```
  * write a 12-bit number X to the current loop: (0-4095 corresponds to 3.8-20.7mA)   
  ```analogWrite(PIN_DAC0, X);```
* The functions of the 6 GPIO pins can be chosen as options in the IDE menu *Tools > Board*
  * SPI + I2C
  * SPI + UART
  * I2C + UART
* The 3V3 pin can be switched on and off in the code:  
```digitalWrite(PIN_EXT_3V3_ENABLE, HIGH);```  
  The initial state of this pin can be set as an option in the IDE menu *Tools > Board*


# GPIO

The green screw connector gives access to 6 GPIO pins, with additional functions according to the option chosen in the IDE menu *Tools > Board*:

| header pin number	| MCU pin	| additional function |
| --- | --- | --- | 
| 1	| D1	| SPI_MISO  |
| 2	|	D2 | SPI_SS |
| 3	| D3	| SPI_MOSI |
| 4	| D4	| SPI_SCK |
| 5	| D5	| UART_TX or I2C_SDA |
| 6	| D6	| UART_RX or I2C_SCL|
| 7 | GND | GND | 
| 8 | 3V3 | 3V3 on or off | 


# WDT

We can use the WDT functions available in the SAML core. The WDT period can be set from 8ms to 16sec. Additional features are documented in the SAML datasheet.

To initialise, configure, and enable the WDT:
```
  WDT->CTRLA.reg = 0;                       // init
  WDT->CONFIG.reg = WDT_CONFIG_PER_CYC2048; // set timeout period based on 1.024kHz clock, from 8ms to 16sec, CYC = 1ms
  // options: WDT_CONFIG_PER_CYC8 WDT_CONFIG_PER_CYC16 WDT_CONFIG_PER_CYC32 WDT_CONFIG_PER_CYC64 WDT_CONFIG_PER_CYC128
  // WDT_CONFIG_PER_CYC256 WDT_CONFIG_PER_CYC512 WDT_CONFIG_PER_CYC1024 WDT_CONFIG_PER_CYC2048 WDT_CONFIG_PER_CYC4096
  // WDT_CONFIG_PER_CYC8192 WDT_CONFIG_PER_CYC16384

  WDT->CTRLA.reg = WDT_CTRLA_ENABLE;        // enable
```
To clear the WDT:
```
  WDT->CLEAR.reg = WDT_CLEAR_CLEAR_KEY;   // reset the WDT: without this line, the WDT would cause a reset after the period defined above
```


# Application notes


### Power supply

While powering the 4-20mAker with 12V is possible, it leaves almost no power available to connect additional sensors, so we recommend 24V. Lower voltage may be used, resulting in a reduced output range e.g. 10-20mA.


### Current range

The 4-20mAker can output a range from 3.8 to 21mA.
However, if devices connected to it draw more than a few mA (e.g. an RC522 RFID reader) then the 4-20mAker will not be able to reach the lower end of the current range. A simple solution is to reduce the output range to e.g. 10-20mA.

